<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>..//GENFIRE/gui/ProjectionCalculator</title>
  <meta name="description" content="GENFIRE Documentation">
  <meta name="author" content="Alan (AJ) Pryor, Jr.">  <link rel="stylesheet" href="css/styles.css?v=1.0">
  <link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
<code>"""<br>* GENFIRE.gui.ProjectionCalculator *<br><br>The projection calculator module<br><br><br>Author: Alan (AJ) Pryor, Jr.<br>Jianwei (John) Miao Coherent Imaging Group<br>University of California, Los Angeles<br>Copyright 2015-2016. All rights reserved.<br>"""<br><br><br><font color="orange">from </font>__future__ <font color="orange">import </font>print_function<br><br><font color="orange">from </font>PyQt4 <font color="orange">import </font>QtCore, QtG<font color="orange">ui<br></font><font color="orange">import </font>os<br><font color="orange">import </font>numpy as np<br><font color="orange">import </font>matplotlib.pyplot as <font color="orange">plt<br></font><font color="orange">from </font>matplotlib.backends.backend_qt4agg <font color="orange">import </font>FigureCanvasQTAgg as FigureCanvas<br><font color="orange">from </font>matplotlib.backends.backend_qt4agg <font color="orange">import </font>NavigationToolbar2QT as NavigationToolbar<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.g<font color="orange">ui </font><font color="orange">import </font>ProjectionCalculator_MainWindow<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.g<font color="orange">ui </font><font color="orange">import </font>CalculateProjectionSeries_Dialog<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.g<font color="orange">ui.</font>utility <font color="orange">import </font>toString, toQString, toInt, toFloat<br><font color="orange">from </font><b><font color="orange">GENFIRE</font></b>.utility <font color="orange">import </font>*<br><font color="orange">import </font><b><font color="orange">GENFIRE</font></b><br><font color="orange">class </font>ProjectionCalculator(<font color="orange">QtG<font color="orange">ui.</font></font>QMainWindow):<br>    model_loading_signal = <font color="orange">QtCore.</font>pyqtSignal()<br>    update_filenames_signal = <font color="orange">QtCore.</font>pyqtSignal()<br>    emit_message_signal = <font color="orange">QtCore.</font>pyqtSignal(str)<br>    <font color="orange">def </font>__init__(self, parent=None):<br>        super(ProjectionCalculator, self).__init__()<br>        <font color="orange">self.</font><font color="orange">ui </font>= ProjectionCalculator_MainWindow.Ui_ProjectionCalculator()<br>        <font color="orange">self.</font><font color="orange">ui.</font>setupUi(self) # buid the interface<br>        <font color="orange">self.</font>parent = parent<br>        <font color="orange">self.</font>calculationParameters = ProjectionCalculationParameters()<br><br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_modelFile.setText(toQString(os.getcwd()))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_modelFile.editingFinished.connect(<font color="orange">self.</font>setModelFilename_fromLineEdit)<br><br>        ## Push Buttons<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_selectMo<font color="orange">del.</font>clicked.connect(<font color="orange">self.</font>selectModelFile)<br><br>        ## Sliders<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_phi.setValue(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_phi.setMinimum(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_phi.setMaximum(3600)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_phi.valueChanged.connect(<font color="orange">self.</font>setPhiLineEditValue)<br><br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_theta.setValue(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_theta.setMinimum(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_theta.setMaximum(3600)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_theta.valueChanged.connect(<font color="orange">self.</font>setThetaLineEditValue)<br><br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_psi.setValue(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_psi.setMinimum(0)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_psi.setMaximum(3600)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_psi.valueChanged.connect(<font color="orange">self.</font>setPsiLineEditValue)<br><br>        ## Line edits<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.setText(toQString('0'))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_theta.setText(toQString('0'))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.setText(toQString('0'))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.editingFinished.connect(<font color="orange">self.</font>setPhiSliderValue)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_theta.editingFinished.connect(<font color="orange">self.</font>setThetaSliderValue)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.editingFinished.connect(<font color="orange">self.</font>setPsiSliderValue)<br><br>        <font color="orange">self.</font>calculateProjections_Dialog = CalculateProjectionSeries_popup(<font color="orange">self.</font>calculationParameters)<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_go.clicked.connect(<font color="orange">self.</font>showDialog)<br>        <font color="orange">self.</font>calculateProjections_Dialog.<font color="orange">ui.</font>buttonBox.accepted.connect(<font color="orange">self.</font>readyToCalculateProjections)<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_go.setEnabled(False)<br><br>        # Create figures for embedded plotting<br>        <font color="orange">self.</font>figure = <font color="orange">plt.</font>figure(3)<br>        <font color="orange">self.</font>figure.clf() # clear figure in case it was rendered somewhere else previously<br>        <font color="orange">self.</font>canvas = FigureCanvas(<font color="orange">self.</font>figure)<br>        <font color="orange">self.</font>navigationToolbar = NavigationToolbar(<font color="orange">self.</font>canvas, self)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalLayout_figure.addWidget(<font color="orange">self.</font>navigationToolbar)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalLayout_figure.addWidget(<font color="orange">self.</font>canvas)<br>        <font color="orange">self.</font>ax = <font color="orange">self.</font>figure.add_subplot(111)<br>        <font color="orange">self.</font>ax.axes.get_xaxis().set_visible(False)<br>        <font color="orange">self.</font>ax.axes.get_yaxis().set_visible(False)<br>        <font color="orange">self.</font>ax.hold(False)<br><br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_clearMo<font color="orange">del.</font>clicked.connect(<font color="orange">self.</font>clearModel)<br><br>    <font color="orange">def </font>showDialog(self):<br>        <font color="orange">self.</font>calculateProjections_Dialog.show()<br><br>    <font color="orange">def </font>readyToCalculateProjections(self):<br>        <font color="orange">self.</font>emit_message_signal.emit("<b><font color="orange">GENFIRE</font></b>: Calculating projections...")<br>        <font color="orange">self.</font>calculation_thread = ProjectionCalculator_thread(self)<br>        <font color="orange">self.</font>calculation_thread.finished.connect(<font color="orange">self.</font>readyToClose)<br>        <font color="orange">self.</font>calculation_thread.start()<br>        <font color="orange">self.</font>parent.raise_()<br><br>    <font color="orange">def </font>readyToClose(self):<br>        <font color="orange">self.</font>update_filenames_signal.emit()<br>        <font color="orange">self.</font>close()<br><br>    <font color="orange">def </font>calculateProjections(self):<br>        <font color="orange">if </font><font color="orange">self.</font>calculateProjections_Dialog.status:<br>            <font color="orange">self.</font>calculationParameters.modelFilename = toString(<font color="orange">self.</font>calculationParameters.modelFilename)<br>            <font color="orange">if </font>not <font color="orange">self.</font>calculationParameters.modelLoadedFlag:<br><br>                <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= <b><font color="orange">GENFIRE</font></b>.fileio.readVolume(<font color="orange">self.</font>calculationParameters.modelFilename)<br>                <font color="orange">self.</font>calculationParameters.oversamplingRatio = <font color="orange">self.</font>calculationParameters.oversamplingRatio<br>                <font color="orange">self.</font>calculationParameters.dims = np.shape(<font color="orange">self.</font>calculationParameters.model)<br>                paddedDim = <font color="orange">self.</font>calculationParameters.dims[0] * <font color="orange">self.</font>calculationParameters.oversamplingRatio<br>                padding = int((paddedDim-<font color="orange">self.</font>calculationParameters.dims[0])/2)<br>                <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= np.pad(<font color="orange">self.</font>calculationParameters.model,((padding,padding),(padding,padding),(padding,padding)),'constant')<br>                <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= fftn_fftshift(<font color="orange">self.</font>calculationParameters.model)<br>                <font color="orange">self.</font>calculationParameters.interpolator = <b><font color="orange">GENFIRE</font></b>.utility.getProjectionInterpolator(<font color="orange">self.</font>calculationParameters.model)<br>            <font color="orange">self.</font>calculationParameters.ncOut = np.shape(<font color="orange">self.</font>calculationParameters.model)[0]//2<br><br><br>            <font color="orange">if </font><font color="orange">self.</font>calculationParameters.angleFileProvided:<br>                <font color="orange">self.</font>calculationParameters.angleFilename = toString(<font color="orange">self.</font>calculationParameters.angleFilename)<br>                <font color="orange">self.</font>calculationParameters.outputFilename = toString(<font color="orange">self.</font>calculationParameters.outputFilename)<br>                angles = np.loadtxt(toString(<font color="orange">self.</font>calculationParameters.angleFilename))<br>                phi = angles[:, 0]<br>                theta = angles[:, 1]<br>                psi = angles[:, 2]<br>                filename = <font color="orange">self.</font>calculationParameters.outputFilename +'.npy'<br>                projections = np.zeros((<font color="orange">self.</font>calculationParameters.dims[0],<font color="orange">self.</font>calculationParameters.dims[1],np.size(phi)),dtype=float)<br>                <font color="orange">if </font><font color="orange">self.</font>calculationParameters.interpolator is None:<br>                    <font color="orange">self.</font>calculationParameters.interpolator = <b><font color="orange">GENFIRE</font></b>.utility.getProjectionInterpolator(<font color="orange">self.</font>calculationParameters.model)<br>                <font color="orange">for </font>projNum in range(0,np.size(phi)):<br>                    pj = <b><font color="orange">GENFIRE</font></b>.utility.calculateProjection_interp_fromInterpolator(<font color="orange">self.</font>calculationParameters.interpolator, phi[projNum], theta[projNum], psi[projNum], np.shape(<font color="orange">self.</font>calculationParameters.model))<br>                    projections[:, :, projNum] = pj[<font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[0]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[0]/2), <font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[1]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[1]/2)]<br><br>                <b><font color="orange">GENFIRE</font></b>.fileio.writeVolume(filename, projections)<br>            else:<br>                <font color="orange">if </font><font color="orange">self.</font>calculationParameters.interpolator is None:<br>                    <font color="orange">self.</font>calculationParameters.interpolator = <b><font color="orange">GENFIRE</font></b>.utility.getProjectionInterpolator(<font color="orange">self.</font>calculationParameters.model)<br>                phi = <font color="orange">self.</font>calculationParameters.phi<br>                psi = <font color="orange">self.</font>calculationParameters.psi<br>                theta = np.arange(<font color="orange">self.</font>calculationParameters.thetaStart, \<br>                                  <font color="orange">self.</font>calculationParameters.thetaStop + 1e-10, \<br>                                  <font color="orange">self.</font>calculationParameters.thetaStep)<br>                projections = np.zeros((<font color="orange">self.</font>calculationParameters.dims[0],<font color="orange">self.</font>calculationParameters.dims[1],np.size(theta)),dtype=float)<br>                <font color="orange">for </font>i, current_theta in enumerate(theta):<br><br>                    pj = <b><font color="orange">GENFIRE</font></b>.utility.calculateProjection_interp_fromInterpolator(<font color="orange">self.</font>calculationParameters.interpolator, phi, current_theta, psi, np.shape(<font color="orange">self.</font>calculationParameters.model))<br>                    projections[:, :, i] = pj[<font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[0]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[0]/2), <font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[1]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[1]/2)]<br>                filename = <font color="orange">self.</font>calculationParameters.outputFilename<br>                filename = toString(filename)<br>                # projections[ projections<0 ] = 0<br>                <b><font color="orange">GENFIRE</font></b>.fileio.writeVolume(filename, projections)<br>                <font color="orange">if </font><font color="orange">self.</font>calculationParameters.writeAnglesFlag:<br>                    output_filename_base, ext  = os.path.splitext(toString(<font color="orange">self.</font>calculationParameters.outputFilename))<br>                    output_angle_filename      = output_filename_base + "_euler_angles.txt"<br>                    <font color="orange">if </font>os.path.isfile(output_angle_filename):<br>                        print("WARNING! Filename {} already exists and will be overwritten.".format(output_angle_filename))<br>                    <font color="orange">self.</font>calculationParameters.outputAngleFilename = output_angle_filename<br>                    num_projections = np.size(theta)<br>                    phi = np.repeat(phi, num_projections)<br>                    psi = np.repeat(psi, num_projections)<br>                    <font color="orange">with </font>open(output_angle_filename,'w') as fid:<br>                        <font color="orange">for </font>euler in zip(phi, theta, psi):<br>                            string = str(euler[0]) + ' ' + str(euler[1]) + ' ' + str(euler[2]) + '\n'<br>                            fid.write(string)<br>                    print("Successfully calculated {}.".format(output_angle_filename))<br><br><br>            print("Successfully calculated {}.".format(filename))<br><br>    <font color="orange">def </font>clearModel(self):<br>        <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>        = None<br>        <font color="orange">self.</font>calculationParameters.interpolator  = None<br>        <font color="orange">self.</font>calculationParameters.modelFilename = None<br>        <font color="orange">self.</font>clearFigure()<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_go.setEnabled(False)<br><br>    <font color="orange">def </font>displayFigure(self):<br>        <font color="orange">if </font><font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>is not None:<br>            pj = <b><font color="orange">GENFIRE</font></b>.utility.calculateProjection_interp_fromInterpolator(<font color="orange">self.</font>calculationParameters.interpolator, <font color="orange">self.</font>calculationParameters.phi, <font color="orange">self.</font>calculationParameters.theta, <font color="orange">self.</font>calculationParameters.psi, np.shape(<font color="orange">self.</font>calculationParameters.model))<br>            pj = pj[<font color="orange">self.</font>calculationParameters.ncOut-int(int(<font color="orange">self.</font>calculationParameters.dims[0]/2)):<font color="orange">self.</font>calculationParameters.ncOut+int(int(<font color="orange">self.</font>calculationParameters.dims[0]/2)), <font color="orange">self.</font>calculationParameters.ncOut-int(int(<font color="orange">self.</font>calculationParameters.dims[1]/2)):<font color="orange">self.</font>calculationParameters.ncOut+int(int(<font color="orange">self.</font>calculationParameters.dims[1]/2))]<br>            pj[ pj<0 ] = 0<br>            <font color="orange">self.</font>showProjection(pj)<br>        else:<br>            <font color="orange">self.</font>clearFigure()<br><br>    <font color="orange">def </font>updateFigure(self):<br>        <font color="orange">if </font><font color="orange">self.</font>calculationParameters.interpolator is None:<br>            <font color="orange">self.</font>calculationParameters.interpolator = <b><font color="orange">GENFIRE</font></b>.utility.getProjectionInterpolator(<font color="orange">self.</font>calculationParameters.model)<br>        pj = <b><font color="orange">GENFIRE</font></b>.utility.calculateProjection_interp_fromInterpolator(<font color="orange">self.</font>calculationParameters.interpolator, <font color="orange">self.</font>calculationParameters.phi, <font color="orange">self.</font>calculationParameters.theta, <font color="orange">self.</font>calculationParameters.psi, np.shape(<font color="orange">self.</font>calculationParameters.model))<br>        pj = pj[<font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[0]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[0]/2), <font color="orange">self.</font>calculationParameters.ncOut-int(<font color="orange">self.</font>calculationParameters.dims[1]/2):<font color="orange">self.</font>calculationParameters.ncOut+int(<font color="orange">self.</font>calculationParameters.dims[1]/2)]<br>        pj[ pj<0 ] = 0<br>        <font color="orange">self.</font>ax.imshow(pj)<br>        <font color="orange">self.</font>canvas.draw()<br><br><br>    <font color="orange">def </font>showProjection(self, pj):<br>        <font color="orange">self.</font>ax.imshow(pj)<br>        <font color="orange">self.</font>canvas.draw()<br><br>    <font color="orange">def </font>clearFigure(self):<br>        <font color="orange">self.</font>figure.clf()<br>        <font color="orange">self.</font>canvas.draw()<br>        <font color="orange">self.</font>ax = <font color="orange">self.</font>figure.add_subplot(111)<br>        <font color="orange">self.</font>ax.axes.get_xaxis().set_visible(False)<br>        <font color="orange">self.</font>ax.axes.get_yaxis().set_visible(False)<br>        <font color="orange">self.</font>ax.hold(False)<br><br>    <font color="orange">def </font>setPhiSliderValue(self):<br>        value = toFloat(<font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.text())<br>        value = int(value * 10)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_phi.setValue(value)<br><br>    <font color="orange">def </font>setThetaSliderValue(self):<br>        value = toFloat(<font color="orange">self.</font><font color="orange">ui.</font>lineEdit_theta.text())<br>        value = int(value * 10)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_theta.setValue(value)<br><br>    <font color="orange">def </font>setPsiSliderValue(self):<br>        value = toFloat(<font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.text())<br>        value = int(value * 10)<br>        <font color="orange">self.</font><font color="orange">ui.</font>verticalSlider_psi.setValue(value)<br><br><br>    <font color="orange">def </font>setPhiLineEditValue(self, value):<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.setText(toQString(float(value)/10))<br>        <font color="orange">self.</font>calculationParameters.phi = float(value)/10<br>        <font color="orange">self.</font>updateFigure()<br><br>    <font color="orange">def </font>setThetaLineEditValue(self, value):<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_theta.setText(toQString(float(value)/10))<br>        <font color="orange">self.</font>calculationParameters.theta = float(value)/10<br>        <font color="orange">self.</font>updateFigure()<br><br>    <font color="orange">def </font>setPsiLineEditValue(self, value):<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.setText(toQString(float(value)/10))<br>        <font color="orange">self.</font>calculationParameters.psi = float(value)/10<br>        <font color="orange">self.</font>updateFigure()<br><br>    <font color="orange">def </font>setNumberOfProjections(self, number):<br>        <font color="orange">self.</font>calculationParameters.numberOfProjections = toInt(number)<br><br>    <font color="orange">def </font>setPhiStart(self, phiStart):<br>        <font color="orange">self.</font>calculationParameters.phiStart = toFloat(phiStart)<br><br>    <font color="orange">def </font>setThetaStart(self, thetaStart):<br>        <font color="orange">self.</font>calculationParameters.thetaStart = toFloat(thetaStart)<br><br>    <font color="orange">def </font>setPsiStart(self, psiStart):<br>        <font color="orange">self.</font>calculationParameters.psiStart = toFloat(psiStart)<br><br>    <font color="orange">def </font>setPhiStep(self, phiStep):<br>        <font color="orange">self.</font>calculationParameters.phiStep = toFloat(phiStep)<br><br>    <font color="orange">def </font>setThetaStep(self, thetaStep):<br>        <font color="orange">self.</font>calculationParameters.thetaStep = toFloat(thetaStep)<br><br>    <font color="orange">def </font>setPsiStep(self, psiStep):<br>        <font color="orange">self.</font>calculationParameters.psiStep = toFloat(psiStep)<br><br>    <font color="orange">def </font>selectOutputDirectory(self):<br>        dirname = <font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog.getExistingDirectory(<font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog(), "Select File Containing Angles",options=<font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog.ShowDirsOnly)<br>        <font color="orange">if </font>dirname:<br>            <font color="orange">self.</font>calculationParameters.outputFilename =  dirname<br>            # self.ui.lineEdit_outputFilename.setText(toQString(dirname))<br><br>    <font color="orange">def </font>setModelFilename_fromLineEdit(self):<br>        filename = <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_modelFile.text()<br>        <font color="orange">if </font>os.path.isfile(toString(filename)) and filename != <font color="orange">self.</font>calculationParameters.modelFilename:<br>            <font color="orange">self.</font>setModelFilename(toString(filename))<br><br>    <font color="orange">def </font>setModelFilename(self, filename):<br>        <font color="orange">self.</font>calculationParameters.modelFilename = filename<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_modelFile.setText(toQString(filename))<br>        <font color="orange">self.</font>loadModel(filename)<br>        <font color="orange">self.</font>displayFigure()<br><br>    <font color="orange">def </font>selectModelFile(self):<br>        filename = <font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog.getOpenFileName(<font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog(), "Select File Containing Model",filter="Volume files (*.mrc *.mat *.npy);;MATLAB files (*.mat);;TIFF images (*.t<font color="orange">if </font>*.tiff);;MRC (*.mrc);;numpy (*.npy);;All Files (*)")<br>        print(filename)<br>        <font color="orange">if </font>os.path.isfile(toString(filename)):<br>            <font color="orange">self.</font><font color="orange">ui.</font>btn_go.setEnabled(True)<br>            <font color="orange">self.</font>setModelFilename(filename)<br><br>    <font color="orange">def </font>loadModel(self, filename):<br>        <font color="orange">self.</font>calculationParameters.oversamplingRatio, ok = <font color="orange">QtG<font color="orange">ui.</font></font>QInputDialog.getInt(self, "Select Oversampling Ratio","Oversampling Ratio = ",value=3,min=1,max=10,step=1)<br>        <font color="orange">from </font>threading <font color="orange">import </font>Thread<br>        t = Thread(target=lambda:print("Loading Mo<font color="orange">del.</font>.."))<br>        t.start()<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_go.setEnabled(True)<br>        <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= <b><font color="orange">GENFIRE</font></b>.fileio.readVolume(toString(filename))<br>        <font color="orange">self.</font>calculationParameters.dims = np.shape(<font color="orange">self.</font>calculationParameters.model)<br>        <font color="orange">self.</font>calculationParameters.paddedDim = <font color="orange">self.</font>calculationParameters.dims[0] * <font color="orange">self.</font>calculationParameters.oversamplingRatio<br>        padding = int((<font color="orange">self.</font>calculationParameters.paddedDim-<font color="orange">self.</font>calculationParameters.dims[0])/2)<br>        <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= np.pad(<font color="orange">self.</font>calculationParameters.model,((padding,padding),(padding,padding),(padding,padding)),'constant')<br>        <font color="orange">self.</font>calculationParameters.mo<font color="orange">del </font>= fftn_fftshift(<font color="orange">self.</font>calculationParameters.model)<br>        <font color="orange">self.</font>calculationParameters.ncOut = int(np.shape(<font color="orange">self.</font>calculationParameters.model)[0]//2)<br>        <font color="orange">self.</font>calculationParameters.interpolator = <b><font color="orange">GENFIRE</font></b>.utility.getProjectionInterpolator(<font color="orange">self.</font>calculationParameters.model)<br>        t.join()<br><br>    <font color="orange">def </font>setAngleFilename(self, filename):<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font>calculationParameters.angleFilename = filename<br><br>    <font color="orange">def </font>toggleSaveProjections(self):<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.modelFilename)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.angleFilename)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.outputFilename)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.outputFilesFlag)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.phiStart)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.thetaStart)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.psiStart)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.phiStep)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.thetaStep)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.psiStep)<br>        print  (<b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.calculationParameters.numberOfProjections)<br><br><br>        <font color="orange">if </font><font color="orange">self.</font>calculationParameters.outputFilesFlag:<br>            <font color="orange">self.</font>calculationParameters.outputFilesFlag = <font color="orange">False<br></font>        else:<br>            <font color="orange">self.</font>calculationParameters.outputFilesFlag = <font color="orange">True<br></font><br>    <font color="orange">def </font>setOutputFilename(self, filename):<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font>calculationParameters.outputFilename = filename<br><br><br><font color="orange">class </font>ProjectionCalculationParameters:<br>    oversamplingRatio = 3<br>    <font color="orange">def </font>__init__(self):<br>        <font color="orange">self.</font>modelFilename              = toQString('')<br>        <font color="orange">self.</font>angleFilename              = toQString('')<br>        <font color="orange">self.</font>outputFilename             = toQString('')<br>        <font color="orange">self.</font>outputAngleFilename        = toQString('')<br>        <font color="orange">self.</font>outputFilesFlag            = <font color="orange">False<br></font>        <font color="orange">self.</font>angleFileProvided          = <font color="orange">False<br></font>        <font color="orange">self.</font>modelFilenameProvided      = <font color="orange">False<br></font>        <font color="orange">self.</font>modelLoadedFlag            = <font color="orange">False<br></font>        <font color="orange">self.</font>writeAnglesFlag            = <font color="orange">True<br></font>        <font color="orange">self.</font>interpolator               = None<br>        <font color="orange">self.</font>mo<font color="orange">del </font>                     = None<br>        <font color="orange">self.</font>ncOut                      = None<br>        <font color="orange">self.</font>phi                        = 0.0<br>        <font color="orange">self.</font>theta                      = 0.0<br>        <font color="orange">self.</font>thetaStart                 = 0.0<br>        <font color="orange">self.</font>thetaStep                  = 3.0<br>        <font color="orange">self.</font>thetaStop                  = 180.0<br>        <font color="orange">self.</font>psi                        = 0.0<br>        <font color="orange">self.</font>calculationMethod          = "FFT"<br><br><font color="orange">class </font>CalculateProjectionSeries_popup(<font color="orange">QtG<font color="orange">ui.</font></font>QDialog):<br>    <font color="orange">def </font>__init__(self, calculation_parameters = ProjectionCalculationParameters()):<br>        super(CalculateProjectionSeries_popup, self).__init__()<br>        <font color="orange">self.</font>calculationParameters = calculation_parameters<br><br>        <font color="orange">self.</font><font color="orange">ui </font>= CalculateProjectionSeries_Dialog.Ui_CalculateProjectionSeries_Dialog()<br>        <font color="orange">self.</font><font color="orange">ui.</font>setupUi(self)<br>        <font color="orange">self.</font>setModal(True)<br><br>        <font color="orange">import </font>os<br>        <font color="orange">from </font>functools <font color="orange">import </font>partial<br>        <font color="orange">self.</font>calculationParameters.outputFilename = os.path.abspath(os.getcwd() + '/projections.mrc')<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_outputFilename.setText(<font color="orange">self.</font>calculationParameters.outputFilename)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.setText(toQString(str(<font color="orange">self.</font>calculationParameters.phi)))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.setText(toQString(str(<font color="orange">self.</font>calculationParameters.psi)))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStart.setText(toQString(str(<font color="orange">self.</font>calculationParameters.thetaStart)))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStep.setText(toQString(str(<font color="orange">self.</font>calculationParameters.thetaStep)))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStop.setText(toQString(str(<font color="orange">self.</font>calculationParameters.thetaStop)))<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_angleFile.textEdited.connect(<font color="orange">self.</font>setAngleFilename_fromLineEdit)<br>        <font color="orange">self.</font><font color="orange">ui.</font>btn_selectAngleFile.clicked.connect(<font color="orange">self.</font>selectAngleFile)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.textEdited.connect(<font color="orange">self.</font>setPhi)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.textEdited.connect(<font color="orange">self.</font>setPsi)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStart.textEdited.connect(<font color="orange">self.</font>setThetaStart)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStep.textEdited.connect(<font color="orange">self.</font>setThetaStep)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStop.textEdited.connect(<font color="orange">self.</font>setThetaStop)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_outputFilename.textEdited.connect(<font color="orange">self.</font>setOutputFilename)<br>        <font color="orange">self.</font><font color="orange">ui.</font>checkBox_saveAngles.setChecked(True)<br>        <font color="orange">self.</font><font color="orange">ui.</font>checkBox_saveAngles.toggled.connect(<font color="orange">self.</font>toggleSaveAngles)<br>        <font color="orange">self.</font><font color="orange">ui.</font>buttonBox.button(<font color="orange">QtG<font color="orange">ui.</font></font>QDialogButtonBox.Ok).setText("Calculate Projections")<br>        <font color="orange">self.</font><font color="orange">ui.</font>buttonBox.accepted.connect(partial(<font color="orange">self.</font>setStatus, 1))<br><br>        <font color="orange">self.</font>status = 0<br><br>    <font color="orange">def </font>setStatus(self,status):<br>        <font color="orange">self.</font>status = status<br><br>    <font color="orange">def </font>setAngleFilename_fromLineEdit(self):<br>        filename = <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_angleFile.text()<br>        <font color="orange">if </font>os.path.isfile(toString(filename)):<br>            <font color="orange">self.</font>calculationParameters.angleFilename = filename<br>            <font color="orange">self.</font>calculationParameters.angleFileProvided = <font color="orange">True<br></font>            <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_angleFile.setText(toQString(filename))<br>            <font color="orange">self.</font>disableAngleWidgets()<br><br>    # def setCalculationMethod(self):<br>    #     if self.ui.radioButton_FFT.isChecked():<br>    #         self.ui.radioButton_DFT.setChecked(False)<br>    #         self.calculationParameters.calculationMethod = "FFT"<br>    #     else:<br>    #         self.ui.radioButton_FFT.setChecked(False)<br>    #         self.calculationParameters.calculationMethod = "DFT"<br><br>    <font color="orange">def </font>selectAngleFile(self):<br>        filename = <font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog.getOpenFileName(<font color="orange">QtG<font color="orange">ui.</font></font>QFileDialog(), "Select File Containing Angles",filter="txt files (*.txt);;All Files (*)")<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font>calculationParameters.angleFilename = filename<br>            <font color="orange">self.</font>calculationParameters.angleFileProvided = <font color="orange">True<br></font>            <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_angleFile.setText(toQString(filename))<br>            <font color="orange">self.</font>disableAngleWidgets()<br>    <font color="orange">def </font>toggleSaveAngles(self):<br>        <font color="orange">if </font><font color="orange">self.</font><font color="orange">ui.</font>checkBox_saveAngles.isChecked():<br>            <font color="orange">self.</font>calculationParameters.writeAnglesFlag = <font color="orange">True<br></font>        else:<br>            <font color="orange">self.</font>calculationParameters.writeAnglesFlag = <font color="orange">False<br></font>    <font color="orange">def </font>disableAngleWidgets(self):<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStart.setEnabled(True)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStep.setDisabled(True)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStop.setDisabled(True)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.setDisabled(True)<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.setDisabled(True)<br><br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStart.setStyleSheet("background-color: gray")<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStep.setStyleSheet("background-color: gray")<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_thetaStop.setStyleSheet("background-color: gray")<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_phi.setStyleSheet("background-color: gray")<br>        <font color="orange">self.</font><font color="orange">ui.</font>lineEdit_psi.setStyleSheet("background-color: gray")<br>        <font color="orange">self.</font><font color="orange">ui.</font>checkBox_saveAngles.setChecked(False)<br>        <font color="orange">self.</font><font color="orange">ui.</font>checkBox_saveAngles.setEnabled(False)<br><br><br>    <font color="orange">def </font>setPhi(self, angle):<br>        <font color="orange">self.</font>calculationParameters.phi = toFloat(angle)<br><br>    <font color="orange">def </font>setPsi(self, angle):<br>        <font color="orange">self.</font>calculationParameters.psi = toFloat(angle)<br><br>    <font color="orange">def </font>setThetaStart(self, value):<br>        <font color="orange">self.</font>calculationParameters.thetaStart = toFloat(value)<br><br>    <font color="orange">def </font>setThetaStep(self, value):<br>        <font color="orange">self.</font>calculationParameters.thetaStep = toFloat(value)<br><br>    <font color="orange">def </font>setThetaStop(self, value):<br>        <font color="orange">self.</font>calculationParameters.thetaStop = toFloat(value)<br><br>    <font color="orange">def </font>setOutputFilename(self, filename):<br>        <font color="orange">if </font>filename:<br>            <font color="orange">self.</font>calculationParameters.outputFilename = filename<br><br><font color="orange">class </font>ProjectionCalculator_thread(<font color="orange">QtCore.</font>QThread):<br>    <font color="orange">def </font>__init__(self, parent):<br>        super(ProjectionCalculator_thread, self).__init__()<br>        <font color="orange">self.</font>parent = parent<br>    <font color="orange">def </font>run(self):<br>        <font color="orange">self.</font>parent.calculateProjections()<br><font color="orange">if </font>__name__ == "__main__":<br>    <font color="orange">import </font>sys<br><br>    # Startup the application<br>    app = <font color="orange">QtG<font color="orange">ui.</font></font>QApplication(sys.argv)<br><br>    # app.setStyle('plastique')<br>    app.setStyle('mac')<br><br>    # Create the GUI<br>    <b><font color="orange">GENFIRE</font></b>_ProjectionCalculator = ProjectionCalculator()<br><br>    # Render the GUI<br>    <b><font color="orange">GENFIRE</font></b>_ProjectionCalculator.show()<br><br>    sys.exit(app.exec_())<br><br></code></body>
    </html>